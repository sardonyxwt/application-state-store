"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t,r,n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},o=(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}(function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)})(t,e),t.prototype.revertArray=function(e){return e.map(this.revert)}}(function(){function e(){}return e.prototype.convertArray=function(e){return e.map(this.convert)},e}()),function(e,t){void 0===e&&(e=16),void 0===t&&(t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");for(var r="";r.length<e;)r+=t.charAt(Math.floor(Math.random()*t.length));return r}),i=function(e){var t=0,r=e+":"+o(4)+"-"+o(4)+"-"+o(4)+"-"+o(4);return function(){return r+":"+ ++t}};function s(e){return Object.getOwnPropertyNames(e).forEach((function(t){var r=e[t];"object"==typeof r&&null!==r&&s(r)})),Object.freeze(e)}(e=exports.ScopeMacroType||(exports.ScopeMacroType={})).GETTER="GETTER",e.SETTER="SETTER",e.FUNCTION="FUNCTION",(t=exports.ScopeChangeEventType||(exports.ScopeChangeEventType={})).REGISTER_MACRO="REGISTER_MACRO",t.REGISTER_ACTION="REGISTER_ACTION",t.LOCK="LOCK",(r=exports.StoreChangeEventType||(exports.StoreChangeEventType={})).CREATE_SCOPE="CREATE_SCOPE",r.LOCK="LOCK";var c=new Map,a={onCreateStore:function(){return null},onChangeStore:function(){return null},onCreateScope:function(){return null},onChangeScope:function(){return null},onAction:function(){return null},onActionError:function(){return null},onActionListenerError:function(){return null}},u=function(){function e(e,t){var r=this;this._context=null,this._contextEvent=null,this._isActionInProgress=!1,this._actions=new Map,this._listeners=new Map,this._listenerIdGenerator=i("ScopeListener");var n=t.name,o=t.initState,s=t.middleware,c=t.isImmutabilityEnabled,a=t.isSubscribedMacroAutoCreateEnabled,u=t.isFrozen;this.store=e,this.name=n,this.isImmutabilityEnabled=c,this.isSubscribedMacroAutoCreateEnabled=a,this._state=o,this._initState=o,this._middleware=function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),o=0;for(t=0;t<r;t++)for(var i=arguments[t],s=0,c=i.length;s<c;s++,o++)n[o]=i[s];return n}(s).reverse(),this.registerAction("_reset",(function(){return r._initState})),this.registerAction("_restore",(function(e,t){return r._initState=t,t})),this._isFrozen=u}return Object.defineProperty(e.prototype,"isLocked",{get:function(){return this._isFrozen},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isActionDispatchAvailable",{get:function(){return!this._isActionInProgress},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return this._context},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supportActions",{get:function(){return Array.from(this._actions.keys())},enumerable:!1,configurable:!0}),e.prototype.registerAction=function(e,t,r){var n=this;if(this._isFrozen)throw new Error("This scope is locked you can't add new action.");if(this._actions.has(e)||this.isSubscribedMacroAutoCreateEnabled&&e in this)throw new Error("Action name "+e+" is duplicate or reserved in scope "+this.name+".");this._actions.set(e,t);var o=function(t,o){var i=n.dispatch(e,t,o);return r?r(i,t):i};if(this.isSubscribedMacroAutoCreateEnabled){var i="on"+(e.charAt(0).toUpperCase()+e.slice(1));this.registerMacro(i,(function(t,r){return n.subscribe(r,[e])}))}return this[e]=o,a.onChangeScope(this,{type:exports.ScopeChangeEventType.REGISTER_ACTION,actionName:e}),o},e.prototype.registerMacro=function(e,t,r){var n=this;if(void 0===r&&(r=exports.ScopeMacroType.FUNCTION),!t)throw new Error("Macro cannot be null or undefined.");if(this._isFrozen)throw new Error("This scope is locked you can't add new macro.");if(e in this&&("function"==typeof n[e]||r===exports.ScopeMacroType.FUNCTION||r===exports.ScopeMacroType.GETTER&&Object.getOwnPropertyDescriptor(this,e).get||r===exports.ScopeMacroType.SETTER&&Object.getOwnPropertyDescriptor(this,e).set))throw new Error("Macro name "+e+" is reserved in scope "+this.name+".");var o=function(e){return t(n._state,e)};switch(r){case exports.ScopeMacroType.FUNCTION:this[e]=o;break;case exports.ScopeMacroType.GETTER:Object.defineProperty(this,e,{get:o,configurable:!0,enumerable:!0});break;case exports.ScopeMacroType.SETTER:Object.defineProperty(this,e,{set:o,configurable:!0,enumerable:!0})}a.onChangeScope(this,{type:exports.ScopeChangeEventType.REGISTER_MACRO,macroName:e,macroType:r})},e.prototype.dispatch=function(e,t,r){var n=this;void 0===r&&(r=!0);var o=this._actions.get(e);if(!o)throw new Error("This action not exists "+e);if(this._isActionInProgress)throw new Error("Now action dispatch not available. Other action spreads.");this.isImmutabilityEnabled&&t&&"object"==typeof t&&s(t),this._middleware.forEach((function(e){return o=e.appendActionMiddleware(o)}));var i=!this._isActionInProgress;i&&(this._isActionInProgress=!0);var c,u=i?this._state:this._context,p=function(r){return{reason:r,oldState:u,scopeName:n.name,actionName:e,props:t}},h=function(r){var o;return{props:t,oldState:u,newState:r,actionName:e,parentEvent:null!==(o=n._contextEvent)&&void 0!==o?o:null,scopeName:n.name,storeName:n.store.name,childrenEvents:[]}};try{return function(e){n.isImmutabilityEnabled&&e&&"object"==typeof t&&s(e),n._context=e,r&&(i?n._contextEvent=h(e):null==n||n._contextEvent.childrenEvents.push(h(e)));var o=function(e){a.onAction(e),n._listeners.forEach((function(t){try{null==t||t(e)}catch(e){a.onActionListenerError(p(e))}}))};return i&&(n._state=e,n._contextEvent&&(n._contextEvent.childrenEvents.forEach(o),o(n._contextEvent)),n._context=null,n._contextEvent=null,n._isActionInProgress=!1),e}(o(u,t))}catch(e){throw c=p(e),i&&a.onActionError(c),c}},e.prototype.subscribe=function(e,t){var r=this;void 0===t&&(t=[]),t.forEach((function(e){if(!r._actions.has(e))throw new Error("Action ("+e+") not present in scope.")}));var n=this._listenerIdGenerator();return this._listeners.set(n,0===t.length?e:function(r){-1!==t.findIndex((function(e){return e===r.actionName}))&&e(r)}),Object.assign((function(){return r.unsubscribe(n)}),{listenerId:n})},e.prototype.unsubscribe=function(e){return this._listeners.delete(e)},e.prototype.lock=function(){this._isFrozen=!0,a.onChangeScope(this,{type:exports.ScopeChangeEventType.LOCK})},e.prototype.reset=function(e){return this.dispatch("_reset",null,e)},e.prototype.restore=function(e,t){return this.dispatch("_restore",e,t)},e}(),p=function(){function e(e){this._scopes=new Map,this._statesToRestore=new Map,this._scopeNameGenerator=i("Scope"),this.name=e.name,this._isFrozen=e.isFrozen}return Object.defineProperty(e.prototype,"isLocked",{get:function(){return this._isFrozen},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){var e={};return this._scopes.forEach((function(t){e[t.name]=t.state})),e},enumerable:!1,configurable:!0}),e.prototype.createScope=function(e,t){if(void 0===e&&(e={}),this._isFrozen)throw new Error("This Store is locked you can't add new scope.");var r=e.name,n=void 0===r?this._scopeNameGenerator():r,o=e.initState,i=void 0===o?null:o,s=e.middleware,c=void 0===s?[]:s,p=e.isImmutabilityEnabled,h=void 0!==p&&p,f=e.isSubscribedMacroAutoCreateEnabled,l=void 0!==f&&f,E=e.isFrozen,_=void 0!==E&&E;if(this._scopes.has(n))throw new Error("Scope name must unique");var d=t&&this._statesToRestore.has(n),y=d?this._statesToRestore.get(n):i;d&&this._statesToRestore.delete(n);var b=new u(this,{name:n,initState:y,middleware:c,isImmutabilityEnabled:h,isSubscribedMacroAutoCreateEnabled:l,isFrozen:_});return this._scopes.set(n,b),c.forEach((function(e){return e.postSetup(b)})),a.onCreateScope(b),a.onChangeStore(this,{type:exports.StoreChangeEventType.CREATE_SCOPE,scopeName:n}),b},e.prototype.getScope=function(e){return this._scopes.get(e)},e.prototype.hasScope=function(e){return this._scopes.has(e)},e.prototype.lock=function(){this._isFrozen=!0,this._scopes.forEach((function(e){return e.lock()})),a.onChangeStore(this,{type:exports.StoreChangeEventType.LOCK})},e.prototype.reset=function(e){this._scopes.forEach((function(t){return t.reset(e)}))},e.prototype.restore=function(e,t){var r=this;Object.getOwnPropertyNames(e).forEach((function(n){var o=e[n];r.hasScope(n)?r.getScope(n).restore(o,t):r._statesToRestore.set(n,o)}))},e}();function h(e){return c.has(e)}exports.RESET_SCOPE_ACTION="_reset",exports.RESTORE_SCOPE_ACTION="_restore",exports.createStore=function(e){var t=e.name,r=e.isFrozen,n=void 0!==r&&r;if(h(t))throw new Error("Store name must unique");var o=new p({name:t,isFrozen:n});return c.set(t,o),a.onCreateStore(o),o},exports.getState=function(){var e={};return c.forEach((function(t){e[t.name]=t.state})),e},exports.getStore=function(e){return c.get(e)},exports.isStoreExist=h,exports.setStoreDevTool=function(e){Object.assign(a,e)};
