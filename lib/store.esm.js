var t,e,n,r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},o=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}(function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)})(e,t),e.prototype.revertArray=function(t){return t.map(this.revert)}}(function(){function t(){}return t.prototype.convertArray=function(t){return t.map(this.convert)},t}()),function(t,e){void 0===t&&(t=16),void 0===e&&(e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");for(var n="";n.length<t;)n+=e.charAt(Math.floor(Math.random()*e.length));return n}),i=function(t){var e=0,n=t+":"+o(4)+"-"+o(4)+"-"+o(4)+"-"+o(4);return function(){return n+":"+ ++e}};function s(t){return Object.getOwnPropertyNames(t).forEach((function(e){var n=t[e];"object"==typeof n&&null!==n&&s(n)})),Object.freeze(t)}!function(t){t.GETTER="GETTER",t.SETTER="SETTER",t.FUNCTION="FUNCTION"}(t||(t={})),function(t){t.REGISTER_MACRO="REGISTER_MACRO",t.REGISTER_ACTION="REGISTER_ACTION",t.LOCK="LOCK"}(e||(e={})),function(t){t.CREATE_SCOPE="CREATE_SCOPE",t.LOCK="LOCK"}(n||(n={}));var c=new Map,a={onCreateStore:function(){return null},onChangeStore:function(){return null},onCreateScope:function(){return null},onChangeScope:function(){return null},onAction:function(){return null},onActionError:function(){return null},onActionListenerError:function(){return null}},u="_reset",h="_restore",p=function(){function n(t,e){var n=this;this._context=null,this._contextEvent=null,this._isActionInProgress=!1,this._actions=new Map,this._listeners=new Map,this._listenerIdGenerator=i("ScopeListener");var r=e.name,o=e.initState,s=e.middleware,c=e.isImmutabilityEnabled,a=e.isSubscribedMacroAutoCreateEnabled,u=e.isFrozen;this.store=t,this.name=r,this.isImmutabilityEnabled=c,this.isSubscribedMacroAutoCreateEnabled=a,this._state=o,this._initState=o,this._middleware=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),o=0;for(e=0;e<n;e++)for(var i=arguments[e],s=0,c=i.length;s<c;s++,o++)r[o]=i[s];return r}(s).reverse(),this.registerAction("_reset",(function(){return n._initState})),this.registerAction("_restore",(function(t,e){return n._initState=e,e})),this._isFrozen=u}return Object.defineProperty(n.prototype,"isLocked",{get:function(){return this._isFrozen},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isActionDispatchAvailable",{get:function(){return!this._isActionInProgress},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"context",{get:function(){return this._context},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"supportActions",{get:function(){return Array.from(this._actions.keys())},enumerable:!1,configurable:!0}),n.prototype.registerAction=function(t,n,r){var o=this;if(this._isFrozen)throw new Error("This scope is locked you can't add new action.");if(this._actions.has(t)||this.isSubscribedMacroAutoCreateEnabled&&t in this)throw new Error("Action name "+t+" is duplicate or reserved in scope "+this.name+".");this._actions.set(t,n);var i=function(e,n){var i=o.dispatch(t,e,n);return r?r(i,e):i};if(this.isSubscribedMacroAutoCreateEnabled){var s="on"+(t.charAt(0).toUpperCase()+t.slice(1));this.registerMacro(s,(function(e,n){return o.subscribe(n,[t])}))}return this[t]=i,a.onChangeScope(this,{type:e.REGISTER_ACTION,actionName:t}),i},n.prototype.registerMacro=function(n,r,o){var i=this;if(void 0===o&&(o=t.FUNCTION),!r)throw new Error("Macro cannot be null or undefined.");if(this._isFrozen)throw new Error("This scope is locked you can't add new macro.");if(n in this&&("function"==typeof i[n]||o===t.FUNCTION||o===t.GETTER&&Object.getOwnPropertyDescriptor(this,n).get||o===t.SETTER&&Object.getOwnPropertyDescriptor(this,n).set))throw new Error("Macro name "+n+" is reserved in scope "+this.name+".");var s=function(t){return r(i._state,t)};switch(o){case t.FUNCTION:this[n]=s;break;case t.GETTER:Object.defineProperty(this,n,{get:s,configurable:!0,enumerable:!0});break;case t.SETTER:Object.defineProperty(this,n,{set:s,configurable:!0,enumerable:!0})}a.onChangeScope(this,{type:e.REGISTER_MACRO,macroName:n,macroType:o})},n.prototype.dispatch=function(t,e,n){var r=this;void 0===n&&(n=!0);var o=this._actions.get(t);if(!o)throw new Error("This action not exists "+t);if(this._isActionInProgress)throw new Error("Now action dispatch not available. Other action spreads.");this.isImmutabilityEnabled&&e&&"object"==typeof e&&s(e),this._middleware.forEach((function(t){return o=t.appendActionMiddleware(o)}));var i=!this._isActionInProgress;i&&(this._isActionInProgress=!0);var c,u=i?this._state:this._context,h=function(n){return{reason:n,oldState:u,scopeName:r.name,actionName:t,props:e}},p=function(n){var o;return{props:e,oldState:u,newState:n,actionName:t,parentEvent:null!==(o=r._contextEvent)&&void 0!==o?o:null,scopeName:r.name,storeName:r.store.name,childrenEvents:[]}};try{return function(t){r.isImmutabilityEnabled&&t&&"object"==typeof e&&s(t),r._context=t,n&&(i?r._contextEvent=p(t):null==r||r._contextEvent.childrenEvents.push(p(t)));var o=function(t){a.onAction(t),r._listeners.forEach((function(e){try{null==e||e(t)}catch(t){a.onActionListenerError(h(t))}}))};return i&&(r._state=t,r._contextEvent&&(r._contextEvent.childrenEvents.forEach(o),o(r._contextEvent)),r._context=null,r._contextEvent=null,r._isActionInProgress=!1),t}(o(u,e))}catch(t){throw c=h(t),i&&a.onActionError(c),c}},n.prototype.subscribe=function(t,e){var n=this;void 0===e&&(e=[]),e.forEach((function(t){if(!n._actions.has(t))throw new Error("Action ("+t+") not present in scope.")}));var r=this._listenerIdGenerator();return this._listeners.set(r,0===e.length?t:function(n){-1!==e.findIndex((function(t){return t===n.actionName}))&&t(n)}),Object.assign((function(){return n.unsubscribe(r)}),{listenerId:r})},n.prototype.unsubscribe=function(t){return this._listeners.delete(t)},n.prototype.lock=function(){this._isFrozen=!0,a.onChangeScope(this,{type:e.LOCK})},n.prototype.reset=function(t){return this.dispatch("_reset",null,t)},n.prototype.restore=function(t,e){return this.dispatch("_restore",t,e)},n}(),f=function(){function t(t){this._scopes=new Map,this._statesToRestore=new Map,this._scopeNameGenerator=i("Scope"),this.name=t.name,this._isFrozen=t.isFrozen}return Object.defineProperty(t.prototype,"isLocked",{get:function(){return this._isFrozen},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){var t={};return this._scopes.forEach((function(e){t[e.name]=e.state})),t},enumerable:!1,configurable:!0}),t.prototype.createScope=function(t,e){if(void 0===t&&(t={}),this._isFrozen)throw new Error("This Store is locked you can't add new scope.");var r=t.name,o=void 0===r?this._scopeNameGenerator():r,i=t.initState,s=void 0===i?null:i,c=t.middleware,u=void 0===c?[]:c,h=t.isImmutabilityEnabled,f=void 0!==h&&h,l=t.isSubscribedMacroAutoCreateEnabled,d=void 0!==l&&l,E=t.isFrozen,_=void 0!==E&&E;if(this._scopes.has(o))throw new Error("Scope name must unique");var b=e&&this._statesToRestore.has(o),v=b?this._statesToRestore.get(o):s;b&&this._statesToRestore.delete(o);var y=new p(this,{name:o,initState:v,middleware:u,isImmutabilityEnabled:f,isSubscribedMacroAutoCreateEnabled:d,isFrozen:_});return this._scopes.set(o,y),u.forEach((function(t){return t.postSetup(y)})),a.onCreateScope(y),a.onChangeStore(this,{type:n.CREATE_SCOPE,scopeName:o}),y},t.prototype.getScope=function(t){return this._scopes.get(t)},t.prototype.hasScope=function(t){return this._scopes.has(t)},t.prototype.lock=function(){this._isFrozen=!0,this._scopes.forEach((function(t){return t.lock()})),a.onChangeStore(this,{type:n.LOCK})},t.prototype.reset=function(t){this._scopes.forEach((function(e){return e.reset(t)}))},t.prototype.restore=function(t,e){var n=this;Object.getOwnPropertyNames(t).forEach((function(r){var o=t[r];n.hasScope(r)?n.getScope(r).restore(o,e):n._statesToRestore.set(r,o)}))},t}();function l(t){return c.has(t)}function d(t){var e=t.name,n=t.isFrozen,r=void 0!==n&&n;if(l(e))throw new Error("Store name must unique");var o=new f({name:e,isFrozen:r});return c.set(e,o),a.onCreateStore(o),o}function E(t){return c.get(t)}function _(){var t={};return c.forEach((function(e){t[e.name]=e.state})),t}function b(t){Object.assign(a,t)}export{u as RESET_SCOPE_ACTION,h as RESTORE_SCOPE_ACTION,e as ScopeChangeEventType,t as ScopeMacroType,n as StoreChangeEventType,d as createStore,_ as getState,E as getStore,l as isStoreExist,b as setStoreDevTool};
